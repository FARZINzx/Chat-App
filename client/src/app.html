<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- Tailwind CSS output -->
    <link href="./output.css" rel="stylesheet"/>
    <title>WebSocket Chat</title>
</head>
<body class="h-screen bg-white">
<main class="h-full grid grid-cols-4">
    <!-- Sidebar: User List -->
    <section class="col-span-1 bg-gray-200 border-r p-4">
        <h2 class="text-lg font-semibold mb-4">Clients</h2>
        <ul id="client-list" class="space-y-2 text-gray-700">
            <!-- Dynamically populated list of connected clients -->
            <li
                    class="flex items-center gap-2 text-[#00A7BA] w-full h-full bg-slate-400"
            >
                <img
                        src="/client/src/assets/images/avatar-boy.svg"
                        width="50"
                        height="50"
                        alt="avatar-boy"
                />
                <div class="flex items-center gap-2">
                    <p class="text-xl font-semibold">Farzin Hamzehi</p>
                    <p class="text-xl font-semibold"></p>
                </div>
            </li>
        </ul>
    </section>
    <!-- Chat Area -->
    <section class="col-span-3 flex flex-col">
        <!-- Messages Container -->
        <div
                id="messages"
                class="flex-1 overflow-y-auto p-4 space-y-2 bg-white"
        >
            <!-- Incoming/outgoing messages will appear here -->
        </div>

        <!-- Message Input Form -->
        <form id="message-form" class="p-4 border-t flex gap-2">
            <input
                    id="message-input"
                    type="text"
                    placeholder="Type a message..."
                    class="flex-1 border rounded-l px-4 py-2 focus:outline-none focus:ring"
            />
            <button
                    type="submit"
                    id="message-submit"
                    class="bg-blue-500 text-white px-4 py-2 rounded-r hover:bg-blue-600 outline-0 active:scale-95 duration-300"
            >
                Send
            </button>
        </form>
    </section>
</main>
<script>
    const ws = new WebSocket("ws://localhost:8080");
    const messagesDiv = document.getElementById("messages");
    const clientsList = document.getElementById("client-list");
    const form = document.getElementById("message-form");
    const input = document.getElementById("message-input");
    const messageBtn = document.getElementById("message-submit");

    ws.onmessage = (event) => {
        // 1) parse the JSON payload
        let data;
        try {
            data = JSON.parse(event.data);
        } catch (err) {
            console.error("Non-JSON message:", event.data);
            return;
        }

        // 2) handle by type
        if (data.type === "clients") {
            clientsList.innerHTML = "";
            data.clients.forEach((client) => {
                const li = document.createElement("li");
                li.textContent = client;
                clientsList.appendChild(li);
            });

        } else if (data.type === "port") {
            console.log("Client port:", data.port);
            document.querySelector("#client-port")
                .textContent = `Your port: ${data.port}`;

        } else if (data.type === "message") {
            // 3) create a div and append
            const messageEl = document.createElement("div");
            messageEl.textContent = data.text;
            messageEl.className = "p-2 bg-gray-200 rounded flex justify-start";
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    };

    const sendMessage = () => {
        const text = input.value.trim();
        if (text && ws.readyState === WebSocket.OPEN) {
            // send as JSON
            ws.send(JSON.stringify({type: "message", text, sender: "client"}));

            // locally echo it
            const messageEl = document.createElement("div");
            messageEl.textContent = text;
            messageEl.className =
                "p-2 bg-blue-100 text-blue-800 rounded flex justify-end";
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            input.value = "";
        }
    }

    messageBtn.addEventListener('keydown', (event) => {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    })


    form.addEventListener("submit", (e) => {
        e.preventDefault();
        sendMessage()
    });

    ws.onerror = (error) => {
        console.error("WebSocket error:", error);
    };
</script>

</body>
</html>
